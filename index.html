import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plus, Search, Calendar, Thermometer, Stethoscope, 
  Pill, Syringe, Trash2, HeartPulse, Microscope, Baby, 
  ChevronDown, Save, Eraser, Edit3, X, Clock, 
  CheckCircle2, ShoppingCart, BarChart3, TrendingUp, ShieldAlert, Info, UserCheck, Scale,
  ChevronLeft, ChevronRight, Camera, Image as ImageIcon, Eye, Wifi, WifiOff, Users, Share2, Copy
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, doc, addDoc, 
  updateDoc, deleteDoc, onSnapshot, query, where, getDocs, writeBatch,
  enableIndexedDbPersistence, getDoc, setDoc
} from 'firebase/firestore';
import { 
  getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
} from 'firebase/auth';

// --- Конфигурация Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'health-diary-v2';

// Включение Offline Persistence (данные доступны без интернета)
enableIndexedDbPersistence(db).catch((err) => {
    if (err.code === 'failed-precondition') console.warn("Offline enabled in only one tab.");
    else if (err.code === 'unimplemented') console.warn("Browser doesn't support offline storage.");
});

const CATEGORY_META = {
  illness: { label: 'Болезнь / Осмотр', color: 'bg-emerald-500', lightColor: 'bg-emerald-50 text-emerald-700' },
  vaccine: { label: 'Вакцинация', color: 'bg-amber-500', lightColor: 'bg-amber-50 text-amber-700' }
};

const calculateDetailedAge = (birthDateStr) => {
  if (!birthDateStr) return "Дата?";
  const birthDate = new Date(birthDateStr);
  const today = new Date();
  let years = today.getFullYear() - birthDate.getFullYear();
  let months = today.getMonth() - birthDate.getMonth();
  if (months < 0 || (months === 0 && today.getDate() < birthDate.getDate())) {
    years--;
    months += 12;
  }
  if (years === 0) return `${months} мес.`;
  if (months === 0) return `${years} л.`;
  return `${years} л. ${months} м.`;
};

const getTempColor = (temp) => {
  const t = parseFloat(temp);
  if (isNaN(t)) return 'text-slate-400';
  return t >= 37.1 ? 'text-rose-600 font-black' : 'text-slate-900 font-bold';
};

export default function App() {
  const [user, setUser] = useState(null);
  const [familyId, setFamilyId] = useState(null); 
  const [children, setChildren] = useState([]);
  const [entries, setEntries] = useState([]);
  const [pharmacy, setPharmacy] = useState([]);
  const [selectedChildId, setSelectedChildId] = useState('all');
  const [loading, setLoading] = useState(true);
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  
  const [isEntryModalOpen, setIsEntryModalOpen] = useState(false);
  const [isChildModalOpen, setIsChildModalOpen] = useState(false);
  const [isFamilyModalOpen, setIsFamilyModalOpen] = useState(false);
  const [currentType, setCurrentType] = useState('illness');
  const [monthOffset, setMonthOffset] = useState(0);
  const [filters, setFilters] = useState({ search: '', type: 'all' });
  const [toast, setToast] = useState(null);
  const [editingEntryId, setEditingEntryId] = useState(null);
  const [editingChildId, setEditingChildId] = useState(null);
  const [viewPhoto, setViewPhoto] = useState(null);

  const [statsDateRange, setStatsDateRange] = useState({
    start: new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0],
    end: new Date().toISOString().split('T')[0]
  });

  const getInitialFormData = () => ({
    childId: '', title: '', symptoms: '', assignments: '',
    tempDays: { day1: { min: '36.6', max: '36.6' }, day2: { min: '36.6', max: '36.6' }, day3: { min: '36.6', max: '36.6' } },
    isExtendedFever: false, extendedFeverDays: '', medicines: [], 
    doctorCalled: false, doctorName: '', isHealthy: false,
    date: new Date().toISOString().slice(0, 16),
    healthyDate: new Date().toISOString().split('T')[0], 
    nextDate: '', vaccineStatus: 'done', vaccineTemp: '36.6', vaccineHasTemp: false,
    currentWeight: '', prescriptionPhoto: ''
  });

  const [formData, setFormData] = useState(getInitialFormData());
  const [childFormData, setChildFormData] = useState({ name: '', birthDate: '', weight: '' });

  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) { console.error("Auth failed", e); }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, async (u) => {
      if (u) {
        setUser(u);
        const profileRef = doc(db, 'artifacts', appId, 'users', u.uid, 'settings', 'profile');
        const profileSnap = await getDoc(profileRef);
        if (profileSnap.exists() && profileSnap.data().familyId) {
          setFamilyId(profileSnap.data().familyId);
        } else {
          setFamilyId(u.uid); 
        }
      }
    });
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
      unsubscribe();
    };
  }, []);

  useEffect(() => {
    if (!user || !familyId) return;
    const baseRef = collection(db, 'artifacts', appId, 'public', 'data', 'familyStore');
    
    const unsubscribe = onSnapshot(baseRef, (snap) => {
      const allDocs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const familyDocs = allDocs.filter(d => d.familyId === familyId);

      setChildren(familyDocs.filter(d => d.docType === 'child').map(d => {
        if (!d.birthDate) {
          if (d.name?.toLowerCase() === 'маша') d.birthDate = '2021-08-15';
          if (d.name?.toLowerCase() === 'матвей') d.birthDate = '2018-03-27';
        }
        return d;
      }));
      setEntries(familyDocs.filter(d => d.docType === 'entry'));
      setPharmacy(familyDocs.filter(d => d.docType === 'pharmacy'));
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user, familyId]);

  const showToast = (msg) => {
    setToast(msg);
    setTimeout(() => setToast(null), 3000);
  };

  const copyFamilyId = () => {
    const el = document.createElement('textarea');
    el.value = familyId;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showToast("Код скопирован");
  };

  const joinFamily = async (code) => {
    if (!code || code.length < 5) return;
    if (!window.confirm("Присоединиться к этой семье?")) return;
    const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
    await setDoc(profileRef, { familyId: code.trim() }, { merge: true });
    setFamilyId(code.trim());
    setIsFamilyModalOpen(false);
    showToast("Синхронизация настроена");
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 800000) { showToast("Фото слишком большое"); return; }
    const reader = new FileReader();
    reader.onloadend = () => setFormData(prev => ({ ...prev, prescriptionPhoto: reader.result }));
    reader.readAsDataURL(file);
  };

  const handleOpenEntryModal = (type) => {
    setCurrentType(type);
    setEditingEntryId(null);
    setFormData({ ...getInitialFormData(), childId: '', currentWeight: '' });
    setIsEntryModalOpen(true);
  };

  const handleEditEntry = (entry) => {
    setEditingEntryId(entry.id);
    setCurrentType(entry.type || 'illness');
    setFormData({ ...getInitialFormData(), ...entry });
    setIsEntryModalOpen(true);
  };

  const handleSaveEntry = async () => {
    if (!user || !familyId) return;
    if (!formData.childId) { showToast("Выберите ребенка"); return; }
    if (!formData.title) { showToast("Заполните заголовок"); return; }

    let totalDuration = 0;
    if (formData.isHealthy && formData.healthyDate) {
      const start = new Date(formData.date.split('T')[0]);
      const end = new Date(formData.healthyDate);
      totalDuration = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
    } else {
      if (formData.isExtendedFever) totalDuration = parseInt(formData.extendedFeverDays) || 0;
      else {
        const maxT = Math.max(parseFloat(formData.tempDays.day1.max), parseFloat(formData.tempDays.day2.max), parseFloat(formData.tempDays.day3.max));
        if (maxT > 36.6) totalDuration = 3;
      }
    }

    const dataRef = collection(db, 'artifacts', appId, 'public', 'data', 'familyStore');
    if (formData.currentWeight) {
        const childDoc = doc(db, 'artifacts', appId, 'public', 'data', 'familyStore', formData.childId);
        await updateDoc(childDoc, { weight: parseFloat(formData.currentWeight) });
    }

    let finalData = { ...formData, docType: 'entry', familyId, type: currentType, updatedAt: new Date().toISOString(), calculatedDuration: totalDuration || 0 };

    if (editingEntryId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'familyStore', editingEntryId), finalData);
    else { finalData.createdAt = new Date().toISOString(); await addDoc(dataRef, finalData); }

    if (formData.isHealthy) {
        const q = query(dataRef, where("docType", "==", "pharmacy"), where("familyId", "==", familyId), where("bought", "==", true));
        const snap = await getDocs(q);
        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
    } else if (formData.medicines?.length > 0) {
        for (const med of formData.medicines) {
            if (med.name.trim()) await addDoc(dataRef, { docType: 'pharmacy', familyId, name: med.name, bought: med.hasInStock, needToBuy: !med.hasInStock, isAntibiotic: med.isAntibiotic || false, createdAt: new Date().toISOString() });
        }
    }

    setIsEntryModalOpen(false);
    showToast("Данные сохранены");
  };

  const handleSaveChild = async (e) => {
    e.preventDefault();
    if (!user || !familyId || !childFormData.name || !childFormData.birthDate) return;
    const data = { docType: 'child', familyId, name: childFormData.name, birthDate: childFormData.birthDate, weight: parseFloat(childFormData.weight) || 0, updatedAt: new Date().toISOString() };
    const dataRef = collection(db, 'artifacts', appId, 'public', 'data', 'familyStore');
    if (editingChildId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'familyStore', editingChildId), data);
    else { data.createdAt = new Date().toISOString(); await addDoc(dataRef, data); }
    setIsChildModalOpen(false);
  };

  const deleteItem = async (id, e) => {
    if (e && e.stopPropagation) e.stopPropagation(); 
    if (!window.confirm("Удалить безвозвратно?")) return;
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'familyStore', id));
    showToast("Удалено");
  };

  // --- Вычисления ---
  const vaccinationHistory = useMemo(() => entries.filter(e => e.type === 'vaccine' && e.vaccineStatus === 'done' && (selectedChildId === 'all' || e.childId === selectedChildId)).sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10), [entries, selectedChildId]);
  
  const childStatsList = useMemo(() => {
    const targetChildren = selectedChildId === 'all' ? children : children.filter(c => c.id === selectedChildId);
    return targetChildren.map(child => {
      const childEntries = entries.filter(e => e.childId === child.id);
      const latestIllness = childEntries.filter(e => e.type === 'illness').sort((a,b) => new Date(b.date) - new Date(a.date))[0];
      const isActive = latestIllness && !latestIllness.isHealthy;
      let displayTemp = '36.6';
      if (isActive && latestIllness.tempDays) {
        const allVals = [latestIllness.tempDays.day1.max, latestIllness.tempDays.day2.max, latestIllness.tempDays.day3.max].filter(v => v).map(v => parseFloat(v));
        if (allVals.length > 0) displayTemp = Math.max(...allVals).toString();
      }
      const nextVaccine = entries.filter(e => e.childId === child.id && (e.vaccineStatus === 'pending' || (e.type === 'vaccine' && e.nextDate && new Date(e.nextDate) >= new Date()))).sort((a, b) => new Date(a.nextDate || a.date) - new Date(b.nextDate || b.date))[0];
      return { child, displayTemp, statusText: isActive ? latestIllness.title : 'Здоров(а)', isActive, nextVaccine };
    });
  }, [entries, children, selectedChildId]);

  const filteredEntries = useMemo(() => {
    const targetDate = new Date();
    targetDate.setMonth(targetDate.getMonth() + monthOffset);
    return entries.filter(e => {
      const d = new Date(e.date);
      const mMatch = d.getMonth() === targetDate.getMonth() && d.getFullYear() === targetDate.getFullYear();
      const cMatch = selectedChildId === 'all' || e.childId === selectedChildId;
      const sMatch = (e.title || '').toLowerCase().includes(filters.search.toLowerCase());
      return mMatch && cMatch && sMatch && e.vaccineStatus !== 'pending';
    }).sort((a, b) => new Date(b.date) - new Date(a.date));
  }, [entries, monthOffset, filters, selectedChildId]);

  const globalIllnessStats = useMemo(() => {
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
    return children.map(child => {
      const childEntriesInPeriod = entries.filter(e => e.childId === child.id && e.date.split('T')[0] >= statsDateRange.start && e.date.split('T')[0] <= statsDateRange.end);
      const illnessEntries = childEntriesInPeriod.filter(e => e.type === 'illness');
      const groupedDiseases = {};
      illnessEntries.forEach(e => {
          const key = (e.title || '').trim().toUpperCase();
          if (!groupedDiseases[key]) groupedDiseases[key] = { count: 1, lastDate: e.date };
          else { groupedDiseases[key].count += 1; if (new Date(e.date) > new Date(groupedDiseases[key].lastDate)) groupedDiseases[key].lastDate = e.date; }
      });
      const totalDays = illnessEntries.reduce((sum, e) => sum + (parseInt(e.calculatedDuration) || 0), 0);
      const antibiotics = entries.filter(e => e.childId === child.id && new Date(e.date) >= sixMonthsAgo && (e.medicines || []).some(m => m.isAntibiotic)).flatMap(e => (e.medicines || []).filter(m => m.isAntibiotic).map(m => ({ name: m.name, date: e.date })));
      return { name: child.name, count: illnessEntries.length, diseases: Object.entries(groupedDiseases).map(([name, data]) => ({ name, count: data.count, lastDate: data.lastDate })), totalDays, antibiotics };
    });
  }, [entries, children, statsDateRange]);

  if (loading) return <div className="h-screen flex items-center justify-center bg-white text-emerald-500 font-black animate-pulse uppercase tracking-[0.2em]">Загрузка...</div>;

  return (
    <div className="min-h-screen bg-[#F8FAFC] p-4 md:p-8 text-slate-900 font-sans">
      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 pb-20">
        
        {/* HEADER */}
        <header className="lg:col-span-12 flex flex-col md:flex-row md:items-center justify-between gap-6 mb-4">
          <div className="flex items-center gap-4 text-left">
            <div className="w-16 h-16 bg-emerald-500 rounded-3xl flex items-center justify-center text-white shadow-xl shadow-emerald-100"><Baby size={40} /></div>
            <div>
              <h1 className="text-3xl font-black text-slate-800 uppercase tracking-tighter leading-none">Детское здоровье</h1>
              <div className="flex items-center gap-2 mt-2">
                <div className={`w-2.5 h-2.5 rounded-full ${isOnline ? 'bg-emerald-500 animate-pulse' : 'bg-slate-300'}`}></div>
                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{isOnline ? 'Синхронизация' : 'Офлайн'}</span>
                <button onClick={() => setIsFamilyModalOpen(true)} className="flex items-center gap-1.5 ml-4 bg-white border border-slate-100 px-3 py-1 rounded-xl text-[10px] font-black text-emerald-600 hover:bg-emerald-50 shadow-sm transition-all"><Users size={14}/> Семья</button>
              </div>
            </div>
          </div>
          
          <div className="flex flex-wrap gap-2 p-2 bg-white border border-slate-100 rounded-2xl shadow-sm">
            <button onClick={() => setSelectedChildId('all')} className={`px-6 py-3 rounded-xl text-sm font-bold transition-all ${selectedChildId === 'all' ? 'bg-slate-800 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'}`}>Все</button>
            {children.map(c => (
              <div key={c.id} className="relative group flex items-center">
                <button onClick={() => setSelectedChildId(c.id)} className={`px-6 py-3 rounded-xl text-sm font-bold transition-all ${selectedChildId === c.id ? 'bg-emerald-500 text-white shadow-lg pr-14 text-left' : 'text-slate-500 hover:bg-slate-50'}`}>
                  <div className="flex flex-col leading-none"><span>{String(c.name)}</span><span className="text-[9px] opacity-70 mt-1 font-black uppercase tracking-tighter">{calculateDetailedAge(c.birthDate)}</span></div>
                </button>
                {selectedChildId === c.id && <button onClick={() => { setEditingChildId(c.id); setChildFormData({name:c.name, birthDate:c.birthDate || '', weight:c.weight}); setIsChildModalOpen(true); }} className="absolute right-3 p-1.5 text-white hover:bg-white/20 rounded-lg transition-colors"><Edit3 size={14} /></button>}
              </div>
            ))}
            <button onClick={() => { setEditingChildId(null); setChildFormData({name:'', birthDate:'', weight:''}); setIsChildModalOpen(true); }} className="w-12 h-12 flex items-center justify-center bg-slate-50 rounded-xl text-slate-400 hover:text-emerald-500 border border-dashed border-slate-200 transition-all"><Plus size={24} /></button>
          </div>
        </header>

        {/* WIDGETS */}
        <div className="lg:col-span-8 space-y-8">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
            <div className="bg-white p-7 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-4">
               <div className="flex items-center gap-3 text-rose-500 border-b border-slate-50 pb-3 justify-center"><Thermometer size={24} /><p className="text-[11px] font-black uppercase tracking-widest text-slate-400">Температура</p></div>
               <div className="space-y-4">{childStatsList.map(s => (<div key={s.child.id} className="flex justify-between items-center px-4 text-left"><span className="text-xs font-bold text-slate-400 uppercase">{String(s.child.name)}</span><span className={`text-base font-black ${s.isActive ? 'text-rose-500' : 'text-emerald-500'}`}>{String(s.displayTemp)}°</span></div>))}</div>
            </div>
            <div className="bg-white p-7 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-4">
               <div className="flex items-center gap-3 text-blue-500 border-b border-slate-50 pb-3 justify-center"><Microscope size={24} /><p className="text-[11px] font-black uppercase tracking-widest text-slate-400">Состояние</p></div>
               <div className="space-y-4">{childStatsList.map(s => (<div key={s.child.id} className="flex justify-between items-center px-4 overflow-hidden text-left"><span className="text-xs font-bold text-slate-400 shrink-0 uppercase">{String(s.child.name)}</span><span className={`text-xs font-black truncate text-right ml-2 ${s.isActive ? 'text-slate-700' : 'text-emerald-500'}`}>{s.statusText}</span></div>))}</div>
            </div>
            <div className="bg-amber-500 p-7 rounded-[2.5rem] shadow-lg shadow-amber-100 space-y-4 text-white">
               <div className="flex items-center gap-3 border-b border-white/20 pb-3 justify-center"><Syringe size={24} /><p className="text-[11px] font-black uppercase tracking-widest opacity-80">Прививки</p></div>
               <div className="space-y-4">{childStatsList.map(s => (<div key={s.child.id} className="flex justify-between items-center px-2 text-left"><span className="text-xs font-bold opacity-80 uppercase">{String(s.child.name)}</span><span className="text-[10px] font-black truncate text-right ml-2 opacity-95">{s.nextVaccine ? `${String(s.nextVaccine.title)} (${new Date(s.nextVaccine.nextDate || s.nextVaccine.date).toLocaleDateString()})` : '—'}</span></div>))}</div>
            </div>
          </div>

          <div className="space-y-6">
            <div className="bg-white p-8 rounded-[3.5rem] border border-slate-100 shadow-sm flex justify-center gap-12">
              {Object.keys(CATEGORY_META).map(type => {
                const IconComp = type === 'illness' ? HeartPulse : Syringe;
                return (
                  <button key={type} onClick={() => handleOpenEntryModal(type)} className="flex flex-col items-center gap-4 group">
                    <div className={`w-24 h-24 ${CATEGORY_META[type].color} text-white rounded-[2.5rem] flex items-center justify-center shadow-xl group-hover:scale-105 transition-transform`}><IconComp size={40} /></div>
                    <span className="text-[12px] font-black text-slate-600 uppercase tracking-widest">{CATEGORY_META[type].label}</span>
                  </button>
                );
              })}
            </div>

            <div className="flex flex-col md:flex-row gap-4 bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
              <div className="relative flex-1"><Search className="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300" size={24} /><input type="text" placeholder="Поиск в истории..." className="w-full pl-16 pr-8 py-5 bg-slate-50 rounded-3xl border-none font-bold text-base focus:ring-2 focus:ring-emerald-500 shadow-inner" value={filters.search} onChange={e => setFilters({...filters, search: e.target.value})} /></div>
              <div className="flex items-center gap-4 bg-slate-100 p-3 rounded-3xl">
                <button onClick={() => setMonthOffset(m => m - 1)} className="p-3 bg-white rounded-2xl shadow-sm hover:scale-105 transition-all"><ChevronLeft size={24} /></button>
                <span className="text-sm font-black min-w-[160px] text-center uppercase tracking-widest text-slate-600">
                  {new Date(new Date().getFullYear(), new Date().getMonth() + monthOffset).toLocaleString('ru-RU', { month: 'long', year: 'numeric' })}
                </span>
                <button onClick={() => setMonthOffset(m => m + 1)} className="p-3 bg-white rounded-2xl shadow-sm hover:scale-105 transition-all"><ChevronRight size={24} /></button>
              </div>
            </div>

            <div className="space-y-6 max-h-[900px] overflow-y-auto pr-2 custom-scrollbar pb-10">
              {filteredEntries.map(e => {
                const CatIcon = e.type === 'illness' ? HeartPulse : Syringe;
                const maxTemp = e.tempDays ? Math.max(...[e.tempDays.day1.max, e.tempDays.day2.max, e.tempDays.day3.max].filter(v=>v).map(v=>parseFloat(v))) : 36.6;
                return (
                  <div key={e.id} onClick={() => handleEditEntry(e)} className={`bg-white p-10 rounded-[3rem] border border-slate-100 hover:border-emerald-200 shadow-sm transition-all group relative overflow-hidden cursor-pointer active:scale-[0.99] ${e.isHealthy ? 'bg-slate-50 opacity-80' : ''}`}>
                    <div className={`absolute left-0 top-0 bottom-0 w-3 ${CATEGORY_META[e.type]?.color || 'bg-slate-200'}`}></div>
                    <button onClick={(event) => deleteItem(e.id, event)} className="absolute top-8 right-8 text-slate-200 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-all p-2"><Trash2 size={24} /></button>
                    <div className="flex items-center gap-6 mb-8">
                      <div className={`p-4 rounded-3xl ${CATEGORY_META[e.type]?.lightColor || 'bg-slate-100'}`}><CatIcon size={28}/></div>
                      <div className="flex-1 text-left">
                        <p className="text-[12px] font-black text-slate-400 uppercase tracking-[0.2em]">{CATEGORY_META[e.type]?.label} • {children.find(c => c.id === e.childId)?.name}{e.isHealthy && <span className="ml-4 text-emerald-500 font-black px-3 py-1 bg-emerald-50 rounded-xl uppercase text-[10px]">✓ ВЫЗДОРОВЕЛ(А) {e.calculatedDuration > 0 && `(${String(e.calculatedDuration)} дн.)`}</span>}</p>
                        <p className="text-sm font-bold text-slate-300 mt-2 flex items-center gap-2 tracking-tight leading-none"><Clock size={16}/> {new Date(e.date).toLocaleString('ru-RU', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' })}</p>
                      </div>
                    </div>
                    <h3 className="text-3xl font-black text-slate-800 mb-4 uppercase text-left tracking-tighter leading-tight">{String(e.title)}</h3>
                    {e.prescriptionPhoto && <button onClick={(ev) => { ev.stopPropagation(); setViewPhoto(e.prescriptionPhoto); }} className="mb-6 flex items-center gap-3 bg-emerald-50 text-emerald-600 px-6 py-3 rounded-2xl font-black text-[11px] border border-emerald-100 hover:bg-emerald-100 active:scale-95 transition-all"><Eye size={18}/> Фото назначения</button>}
                    <div className="flex flex-wrap gap-4 mt-2">
                      {e.tempDays && <div className="flex items-center gap-3 bg-slate-50 px-5 py-3 rounded-2xl text-xs font-black shadow-sm border border-slate-100"><Thermometer size={16} className={getTempColor(maxTemp)} /> <span className={getTempColor(maxTemp)}>Макс: {maxTemp}°C</span></div>}
                      {e.medicines?.map((m, i) => <div key={i} className={`flex items-center gap-3 px-5 py-3 rounded-2xl text-xs font-black shadow-sm border ${m.isAntibiotic ? 'bg-red-50 text-red-600 border-red-100' : 'bg-purple-50 text-purple-600 border-purple-100'}`}><Pill size={16} /> {String(m.name)}</div>)}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        {/* RIGHT COL */}
        <div className="lg:col-span-4 space-y-8">
          <div className="bg-white p-10 rounded-[3.5rem] border border-slate-100 shadow-sm text-center">
            <h2 className="text-2xl font-black text-slate-800 flex items-center gap-4 mb-10 uppercase tracking-tighter justify-center"><Syringe className="text-amber-500" size={32} /> Вакцинация</h2>
            <div className="space-y-6">
              {vaccinationHistory.map(v => (
                <div key={v.id} onClick={() => handleEditEntry(v)} className="group p-6 bg-slate-50 hover:bg-white rounded-3xl border border-transparent hover:border-amber-100 transition-all cursor-pointer shadow-sm text-left">
                   <div className="flex justify-between items-center mb-3">
                      <div className="text-[11px] font-black text-amber-500 uppercase tracking-widest">{new Date(v.date).toLocaleDateString()}</div>
                      <span className="text-[10px] font-bold text-slate-300 uppercase">#{children.find(c => c.id === v.childId)?.name}</span>
                   </div>
                   <div className="text-base font-black text-slate-800 uppercase truncate leading-tight tracking-tight">{String(v.title)}</div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white p-10 rounded-[3.5rem] border border-slate-100 shadow-sm text-left">
            <div className="flex items-center justify-between mb-10">
              <h2 className="text-2xl font-black text-slate-800 flex items-center gap-4"><Pill className="text-purple-500" size={32} /> Аптечка</h2>
              <button onClick={async () => { const n = window.prompt("Название препарата:"); if (n) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'familyStore'), { familyId, docType: 'pharmacy', name: n, needToBuy: true, bought: false, createdAt: new Date().toISOString() }); }} className="w-14 h-14 bg-purple-50 text-purple-600 rounded-2xl flex items-center justify-center hover:bg-purple-100 transition-colors shadow-sm"><Plus size={28} /></button>
            </div>
            <div className="space-y-6">
              {pharmacy.filter(p => p.needToBuy).map(item => (
                <div key={item.id} className="flex items-center justify-between p-5 bg-amber-50 rounded-3xl border border-amber-100 group">
                  <span className="text-sm font-black text-amber-900 truncate pr-4 uppercase tracking-tight">{String(item.name)}</span>
                  <div className="flex items-center gap-3 shrink-0">
                    <button onClick={() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'familyStore', item.id), { needToBuy: false, bought: true })} className="text-emerald-500 hover:scale-125 transition-transform"><CheckCircle2 size={24} /></button>
                    <button onClick={(e) => deleteItem(item.id, e)} className="text-rose-400 hover:text-rose-600 transition-all"><X size={22} /></button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* ANALYTICS */}
        <div className="lg:col-span-12 mt-8">
          <div className="bg-white p-12 md:p-16 rounded-[4.5rem] border border-slate-100 shadow-2xl">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-12 mb-16 border-b border-slate-50 pb-12">
               <div className="flex items-center gap-6">
                  <div className="w-20 h-20 bg-indigo-500 text-white rounded-[2rem] flex items-center justify-center shadow-2xl"><BarChart3 size={40}/></div>
                  <h2 className="text-4xl font-black text-slate-800 uppercase tracking-tighter">Аналитика</h2>
               </div>
               <div className="flex gap-6 bg-slate-50 p-5 rounded-[2rem]">
                  <input type="date" className="bg-white border-none rounded-2xl px-6 py-3 text-sm font-bold shadow-sm" value={statsDateRange.start} onChange={e => setStatsDateRange({...statsDateRange, start: e.target.value})} />
                  <input type="date" className="bg-white border-none rounded-2xl px-6 py-3 text-sm font-bold shadow-sm" value={statsDateRange.end} onChange={e => setStatsDateRange({...statsDateRange, end: e.target.value})} />
               </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-16 text-center">
              {globalIllnessStats.map((stat, i) => (
                <div key={i} className="space-y-12 bg-slate-50/50 p-12 rounded-[4rem] border border-slate-100 transition-all hover:bg-white hover:shadow-2xl">
                  <h3 className="text-3xl font-black text-slate-800 uppercase tracking-tighter mb-8">{String(stat.name)}</h3>
                  <div className="grid grid-cols-2 gap-6 text-center">
                    <div className="bg-white p-7 rounded-[2.5rem] shadow-sm"><p className="text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">Случаев</p><p className="text-3xl font-black text-emerald-500">{stat.count}</p></div>
                    <div className="bg-white p-7 rounded-[2.5rem] shadow-sm"><p className="text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">Дней болезни</p><p className="text-3xl font-black text-rose-500">{stat.totalDays}</p></div>
                  </div>
                  {stat.antibiotics.length > 0 && (
                      <div className="bg-red-50 p-8 rounded-[3rem] border border-red-100 text-left">
                        <p className="text-[11px] font-black text-red-500 uppercase mb-6 flex items-center gap-3 tracking-widest"><ShieldAlert size={20}/> Антибиотики (6 мес):</p>
                        <div className="space-y-4">
                           {stat.antibiotics.map((a, ai) => (
                             <div key={ai} className="flex justify-between items-center p-4 bg-white/70 rounded-2xl shadow-inner border border-red-50">
                                <span className="text-sm font-black text-red-900 uppercase tracking-tighter leading-tight">{String(a.name)}</span>
                                <span className="text-[11px] font-bold text-red-400">{new Date(a.date).toLocaleDateString()}</span>
                             </div>
                           ))}
                        </div>
                      </div>
                  )}
                  <div className="text-left"><p className="text-[11px] font-black text-slate-400 uppercase mb-6 ml-4 tracking-widest">Список заболеваний:</p>
                    <div className="flex flex-wrap gap-3">
                        {stat.diseases.map((d, di) => (
                          <div key={di} className="px-5 py-4 bg-emerald-50 text-emerald-700 rounded-3xl flex flex-col items-start border border-emerald-100/50 shadow-sm">
                            <span className="text-[11px] font-black uppercase tracking-tight">{d.name} ({d.count})</span>
                            <span className="text-[9px] font-bold opacity-60 mt-1 uppercase tracking-tighter">Посл: {new Date(d.lastDate).toLocaleDateString()}</span>
                          </div>
                        ))}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* MODAL FAMILY */}
      {isFamilyModalOpen && (
        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-sm z-[110] flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-sm rounded-[3.5rem] shadow-2xl p-12 relative text-center">
            <button onClick={() => setIsFamilyModalOpen(false)} className="absolute top-8 right-8 text-slate-300 hover:text-slate-500 transition-colors"><X size={32}/></button>
            <div className="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-[2rem] flex items-center justify-center mx-auto mb-8 shadow-inner"><Users size={40}/></div>
            <h2 className="text-3xl font-black text-slate-800 uppercase mb-3 tracking-tighter">Семья</h2>
            <div className="space-y-8">
              <div className="bg-slate-50 p-8 rounded-[2.5rem] border-2 border-dashed border-slate-200"><p className="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Ваш семейный код:</p><div className="flex items-center justify-center gap-4"><code className="text-xl font-black text-emerald-600 tracking-wider">{user?.uid.slice(0, 12)}</code><button onClick={copyFamilyId} className="p-3 bg-white rounded-2xl shadow-sm text-slate-400 hover:text-emerald-500 active:scale-95 transition-all"><Copy size={20}/></button></div></div>
              <div className="text-left"><label className="text-[10px] font-black text-slate-400 uppercase ml-6 mb-3 block tracking-widest">Код близкого:</label><div className="flex gap-3"><input id="familyCodeInput" placeholder="..." className="flex-1 bg-slate-50 border-none rounded-3xl p-5 font-black text-slate-700 shadow-inner" /><button onClick={() => joinFamily(document.getElementById('familyCodeInput').value)} className="bg-emerald-500 text-white p-5 rounded-3xl shadow-xl hover:scale-105 active:scale-95 transition-all"><Share2 size={24}/></button></div></div>
            </div>
          </div>
        </div>
      )}

      {/* MODAL ENTRY */}
      {isEntryModalOpen && (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[100] flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-2xl rounded-[4rem] shadow-2xl p-10 md:p-14 overflow-hidden relative">
            <div className="flex justify-between items-start mb-10 text-left"><div className="flex items-center gap-6"><div className={`w-20 h-20 ${CATEGORY_META[currentType]?.color || 'bg-emerald-500'} text-white rounded-[2rem] flex items-center justify-center shadow-2xl`}>{currentType === 'illness' ? <HeartPulse size={40}/> : <Syringe size={40}/>}</div><div><h2 className="text-3xl font-black text-slate-800 uppercase tracking-tighter leading-none">{editingEntryId ? 'Изменить' : 'Новая запись'}</h2><p className="text-[11px] font-black text-slate-300 uppercase mt-2 tracking-widest">{CATEGORY_META[currentType]?.label}</p></div></div><div className="flex gap-3"><button onClick={clearForm} className="w-14 h-14 bg-slate-50 rounded-full flex items-center justify-center text-slate-300 hover:text-rose-500 transition-all"><Eraser size={24}/></button><button onClick={() => setIsEntryModalOpen(false)} className="w-14 h-14 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 hover:bg-slate-200 transition-colors"><X size={28}/></button></div></div>
            <div className="space-y-7 overflow-y-auto max-h-[65vh] pr-6 custom-scrollbar">
              <div className="flex gap-2 bg-slate-50 p-2 rounded-2xl overflow-x-auto no-scrollbar">{Object.keys(CATEGORY_META).map(type => (<button key={type} onClick={() => setCurrentType(type)} className={`flex-1 px-6 py-4 rounded-xl text-[11px] font-black uppercase transition-all whitespace-nowrap ${currentType === type ? CATEGORY_META[type].color + ' text-white shadow-md' : 'text-slate-400 hover:text-slate-600'}`}>{CATEGORY_META[type].label}</button>))}</div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
                <div className="relative"><label className="text-[10px] font-black text-slate-400 uppercase ml-5 mb-2 block tracking-widest">Ребенок</label><select className="w-full bg-slate-50 border-none rounded-[2rem] py-6 pl-6 pr-14 appearance-none font-black text-slate-700 focus:ring-2 focus:ring-emerald-500 shadow-inner" value={formData.childId} onChange={e => { const child = children.find(c => c.id === e.target.value); setFormData({...formData, childId: e.target.value, currentWeight: child?.weight || ''}); }}><option value="" disabled>Выбрать...</option>{children.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                <div className="relative"><label className="text-[10px] font-black text-slate-400 uppercase ml-5 mb-2 block tracking-widest">Вес сегодня</label><input type="number" step="0.1" className="w-full bg-slate-50 border-none rounded-[2rem] p-6 font-black text-emerald-600 shadow-inner focus:ring-2 focus:ring-emerald-500" value={formData.currentWeight} onChange={e => setFormData({...formData, currentWeight: e.target.value})} /><span className="absolute right-6 top-[4rem] text-[10px] font-black text-slate-300">КГ</span></div>
                <div><label className="text-[10px] font-black text-slate-400 uppercase ml-5 mb-2 block tracking-widest">Дата</label><input type="datetime-local" className="w-full bg-slate-50 border-none rounded-[2rem] p-6 font-bold text-slate-700 shadow-inner focus:ring-2 focus:ring-emerald-500" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} /></div>
              </div>
              <div className="flex flex-col md:flex-row gap-6 items-end text-left"><div className="flex-1 w-full"><label className="text-[10px] font-black text-slate-400 uppercase ml-5 mb-2 block tracking-widest">Заголовок</label><input type="text" placeholder="..." className="w-full bg-slate-50 border-none rounded-[2rem] p-7 font-black text-slate-800 shadow-inner uppercase tracking-tighter leading-tight" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} /></div>{currentType === 'illness' && (<label className={`flex items-center gap-4 p-6 rounded-[2.5rem] cursor-pointer transition-all border-2 ${formData.isHealthy ? 'bg-emerald-50 border-emerald-500 text-emerald-600 shadow-lg' : 'bg-slate-50 border-transparent text-slate-400 opacity-60'}`}><input type="checkbox" className="hidden" checked={formData.isHealthy} onChange={() => setFormData({...formData, isHealthy: !formData.isHealthy})} /><UserCheck size={32} /><span className="text-[11px] font-black uppercase tracking-widest">Здоров</span></label>)}</div>
              {currentType === 'illness' && (
                <>
                  {formData.isHealthy && (<div className="bg-emerald-50 p-8 rounded-[3rem] border border-emerald-100 text-left animate-in zoom-in-95 duration-200"><label className="text-[10px] font-black text-emerald-600 uppercase ml-3 mb-3 block tracking-widest">Дата выздоровления</label><input type="date" className="w-full bg-white border-none rounded-[1.5rem] py-5 px-8 font-black text-emerald-700 shadow-inner focus:ring-2 focus:ring-emerald-500" value={formData.healthyDate} onChange={e => setFormData({...formData, healthyDate: e.target.value})} /></div>)}
                  <div className="bg-rose-50/50 p-8 rounded-[3rem] border border-rose-100/50 space-y-5 text-left"><label className="text-[10px] font-black text-rose-400 uppercase ml-3 block tracking-widest">Температура по дням</label>{['day1', 'day2', 'day3'].map((dayKey, idx) => (<div key={dayKey} className="flex items-center gap-6"><div className="shrink-0 text-[10px] font-black text-slate-400 w-12 uppercase tracking-tighter">{idx+1} ДЕНЬ</div><input type="number" step="0.1" placeholder="От" className="flex-1 bg-white border-none rounded-2xl py-5 px-8 font-black text-rose-500 text-base shadow-sm focus:ring-2 focus:ring-rose-200" value={formData.tempDays[dayKey].min} onChange={e => setFormData({...formData, tempDays: {...formData.tempDays, [dayKey]: {...formData.tempDays[dayKey], min: e.target.value}}})} /><input type="number" step="0.1" placeholder="До" className="flex-1 bg-white border-none rounded-2xl py-5 px-8 font-black text-rose-500 text-base shadow-sm focus:ring-2 focus:ring-rose-200" value={formData.tempDays[dayKey].max} onChange={e => setFormData({...formData, tempDays: {...formData.tempDays, [dayKey]: {...formData.tempDays[dayKey], max: e.target.value}}})} /></div>))}<div className="pt-6 border-t border-rose-100/50 flex items-center justify-between"><label className="flex items-center gap-4 cursor-pointer group"><input type="checkbox" className="hidden" checked={formData.isExtendedFever} onChange={() => setFormData({...formData, isExtendedFever: !formData.isExtendedFever})} /><div className={`w-10 h-10 rounded-2xl border-2 flex items-center justify-center transition-all ${formData.isExtendedFever ? 'bg-rose-500 border-rose-500 text-white shadow-md' : 'border-slate-200 bg-white group-hover:border-rose-200'}`}>{formData.isExtendedFever && <CheckCircle2 size={24} />}</div><span className="text-[11px] font-black uppercase text-slate-400 tracking-widest">Более 3-х дней</span></label>{formData.isExtendedFever && <input type="number" placeholder="Всего..." className="w-32 bg-white border-none rounded-2xl p-5 font-black text-rose-500 text-xs shadow-sm focus:ring-2 focus:ring-rose-200" value={formData.extendedFeverDays} onChange={e => setFormData({...formData, extendedFeverDays: e.target.value})} />}</div></div>
                  <div><label className="text-[10px] font-black text-slate-400 uppercase ml-6 mb-3 block tracking-widest">Назначения врача</label><textarea className="w-full bg-slate-50 border-none rounded-[2rem] p-7 font-medium text-slate-700 focus:ring-2 focus:ring-emerald-500 shadow-inner h-28" value={formData.assignments} onChange={e => setFormData({...formData, assignments: e.target.value})} /></div>
                  <div className="bg-emerald-50/50 p-8 rounded-[3rem] border border-emerald-100/50 text-left"><label className="text-[10px] font-black text-emerald-600 uppercase block mb-6 ml-2 tracking-widest">Фото назначения</label><div className="flex items-center gap-6"><label className="cursor-pointer flex items-center gap-4 bg-white px-8 py-5 rounded-[1.5rem] border border-emerald-200 text-emerald-600 font-black text-sm hover:bg-emerald-50 transition-all active:scale-95"><Camera size={24}/><input type="file" accept="image/*" className="hidden" onChange={handleFileChange} /></label>{formData.prescriptionPhoto && <div className="relative group animate-in fade-in zoom-in-50"><img src={formData.prescriptionPhoto} alt="Preview" className="w-20 h-20 rounded-2xl object-cover border-4 border-white shadow-xl" /><button onClick={() => setFormData({...formData, prescriptionPhoto: ''})} className="absolute -top-3 -right-3 w-8 h-8 bg-rose-500 text-white rounded-full flex items-center justify-center shadow-2xl hover:scale-110 transition-transform"><X size={18}/></button></div>}</div></div>
                  <div className="bg-purple-50/50 p-8 rounded-[3rem] border border-purple-100/50 space-y-6 text-left"><div className="flex items-center justify-between px-3"><label className="text-[10px] font-black text-purple-400 uppercase tracking-widest block tracking-widest">Лекарства</label><button onClick={addMedicineRow} className="text-purple-600 bg-white px-4 py-2 rounded-xl transition-all shadow-sm flex items-center gap-2 text-[10px] font-black border border-purple-100"><Plus size={16}/> Добавить</button></div><div className="space-y-4">{formData.medicines.map((med, index) => (<div key={index} className="flex flex-col gap-4 bg-white p-6 rounded-[2rem] shadow-sm border border-purple-100 animate-in slide-in-from-left-4 duration-200"><input type="text" placeholder="Название..." className="w-full px-5 py-3 bg-slate-50 border-none rounded-xl font-bold text-slate-700" value={med.name} onChange={e => { const m = [...formData.medicines]; m[index].name = e.target.value; setFormData({...formData, medicines: m}); }} /><div className="flex flex-wrap items-center justify-between gap-4 px-2"><label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" className="hidden" checked={med.isAntibiotic} onChange={() => { const m = [...formData.medicines]; m[index].isAntibiotic = !m[index].isAntibiotic; setFormData({...formData, medicines: m}); }} /><div className={`w-8 h-8 rounded-xl border-2 flex items-center justify-center transition-all ${med.isAntibiotic ? 'bg-red-500 border-red-500 text-white shadow-md' : 'border-slate-200'}`}>{med.isAntibiotic && <ShieldAlert size={18} />}</div><span className="text-[11px] font-black uppercase text-red-500 tracking-widest">Антибиотик</span></label><label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" className="hidden" checked={med.hasInStock} onChange={() => { const m = [...formData.medicines]; m[index].hasInStock = !m[index].hasInStock; setFormData({...formData, medicines: m}); }} /><div className={`w-8 h-8 rounded-xl border-2 flex items-center justify-center transition-all ${med.hasInStock ? 'bg-emerald-500 border-emerald-500 text-white shadow-md' : 'border-slate-200'}`}>{med.hasInStock && <CheckCircle2 size={18} />}</div><span className="text-[11px] font-black uppercase text-emerald-500 tracking-widest">В наличии</span></label><button onClick={() => setFormData(prev => ({ ...prev, medicines: prev.medicines.filter((_, i) => i !== index) }))} className="text-rose-300 hover:text-rose-500 p-2"><X size={24}/></button></div></div>))}</div></div>
                </>
              )}
              {currentType === 'vaccine' && (
                <div className="bg-amber-50 p-8 rounded-[3rem] border border-amber-100 space-y-8 shadow-sm text-left"><div className="flex gap-4">{['pending', 'done'].map(s => (<button key={s} onClick={() => setFormData({...formData, vaccineStatus: s})} className={`flex-1 py-5 rounded-[1.5rem] text-[11px] font-black uppercase transition-all shadow-md ${formData.vaccineStatus === s ? 'bg-amber-500 text-white' : 'bg-white text-amber-500 border border-amber-100'}`}>{s === 'done' ? 'Сделана' : 'Планирую'}</button>))}</div><div className="grid grid-cols-2 gap-8"><div><label className="text-[10px] font-black text-amber-600 uppercase ml-3 mb-3 block tracking-widest">Температура реакции</label><input type="number" step="0.1" className="w-full bg-white border-none rounded-[1.5rem] py-5 px-8 font-black text-rose-500 shadow-inner" value={formData.vaccineTemp} onChange={e => setFormData({...formData, vaccineTemp: e.target.value})} /></div><div><label className="text-[10px] font-black text-amber-600 uppercase ml-3 mb-3 block tracking-widest">Ревакцинация</label><input type="date" className="w-full bg-white border-none rounded-[1.5rem] py-5 px-8 font-bold text-amber-900 shadow-inner" value={formData.nextDate} onChange={e => setFormData({...formData, nextDate: e.target.value})} /></div></div><div className="flex items-center gap-4 bg-white/50 p-6 rounded-3xl cursor-pointer hover:bg-white transition-all shadow-inner" onClick={() => setFormData({...formData, vaccineHasTemp: !formData.vaccineHasTemp})}><div className={`w-10 h-10 rounded-2xl border-2 flex items-center justify-center transition-all ${formData.vaccineHasTemp ? 'bg-rose-500 border-rose-500 text-white shadow-md' : 'bg-white border-slate-200'}`}>{formData.vaccineHasTemp && <CheckCircle2 size={24}/>}</div><span className="text-[11px] font-black uppercase text-slate-500 tracking-widest">Была реакция (температура)</span></div><div><label className="text-[10px] font-black text-amber-600 uppercase ml-3 mb-3 block tracking-widest">Комментарий</label><textarea className="w-full bg-white border-none rounded-[1.5rem] p-7 font-medium text-slate-700 h-32 focus:ring-2 focus:ring-amber-200 shadow-inner" value={formData.vaccineComment} onChange={e => setFormData({...formData, vaccineComment: e.target.value})} /></div></div>
              )}
              <div className="pt-10 flex flex-col md:flex-row gap-6 pb-10"><button onClick={() => setIsEntryModalOpen(false)} className="flex-1 py-7 bg-slate-100 text-slate-500 font-black uppercase tracking-widest rounded-[2rem] hover:bg-slate-200 transition-colors">Отмена</button><button onClick={handleSaveEntry} className="flex-[2] py-7 bg-emerald-500 text-white font-black uppercase tracking-widest rounded-[2rem] shadow-2xl active:scale-95 flex items-center justify-center gap-4 transition-all hover:bg-emerald-600 tracking-tighter leading-tight"><Save size={28} /> Сохранить запись</button></div>
            </div>
          </div>
        </div>
      )}

      {isChildModalOpen && (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[100] flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-sm rounded-[4rem] shadow-2xl p-12 relative text-center">
            <h2 className="text-3xl font-black text-slate-800 mb-10 flex items-center gap-4 justify-center leading-none"><div className="w-14 h-14 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-500 shadow-inner"><Baby size={32} /></div>Профиль</h2>
            <form onSubmit={handleSaveChild} className="space-y-6">
              <input placeholder="Имя ребенка" className="w-full bg-slate-50 border-none rounded-[1.5rem] p-6 font-black text-slate-800 shadow-inner text-center uppercase tracking-tighter" value={childFormData.name} onChange={e => setChildFormData({...childFormData, name: e.target.value})} required />
              <div className="flex flex-col gap-6 text-left"><div><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-5 mb-2 block">Дата рождения</label><input type="date" className="w-full bg-slate-50 border-none rounded-[1.5rem] p-6 font-black text-slate-800 shadow-inner focus:ring-2 focus:ring-emerald-500" value={childFormData.birthDate} onChange={e => setChildFormData({...childFormData, birthDate: e.target.value})} required /></div><div className="relative"><input type="number" step="0.1" placeholder="Вес" className="w-full bg-slate-50 border-none rounded-[1.5rem] p-6 font-black text-slate-800 shadow-inner text-center" value={childFormData.weight} onChange={e => setChildFormData({...childFormData, weight: e.target.value})} /><span className="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black text-slate-300">КГ</span></div></div>
              <div className="flex flex-col gap-4 pt-6"><button type="submit" className="w-full bg-emerald-500 text-white py-5 rounded-[2rem] font-black uppercase shadow-xl hover:bg-emerald-600 transition-all">Сохранить</button>{editingChildId && <button type="button" onClick={() => deleteItem(editingChildId)} className="w-full text-rose-400 font-black text-[10px] uppercase tracking-widest py-3">Удалить</button>}<button type="button" onClick={() => setIsChildModalOpen(false)} className="w-full py-2 text-slate-300 font-bold text-[10px] uppercase tracking-widest">Назад</button></div>
            </form>
          </div>
        </div>
      )}

      {viewPhoto && (
        <div className="fixed inset-0 bg-slate-900/95 z-[200] flex flex-col items-center justify-center p-6 animate-in fade-in duration-300" onClick={() => setViewPhoto(null)}>
          <button onClick={() => setViewPhoto(null)} className="absolute top-8 right-8 text-white/50 hover:text-white transition-all"><X size={48}/></button>
          <img src={viewPhoto} alt="Full view" className="max-w-full max-h-[85vh] rounded-[2rem] shadow-2xl border-4 border-white/10" />
        </div>
      )}

      {toast && (<div className="fixed bottom-12 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-12 py-6 rounded-[2.5rem] shadow-2xl z-[200] animate-bounce text-sm font-black flex items-center gap-5 border-b-4 border-emerald-500"><CheckCircle2 size={28} className="text-emerald-400" /> {toast}</div>)}

      <style dangerouslySetInnerHTML={{ __html: `
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap');
        body { font-family: 'Nunito', sans-serif; letter-spacing: -0.01em; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 12px; }
      `}} />
    </div>
  );
}
